<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>3D Year Ring – Synesthetic Calendar</title>
<style>
  :root{ --bg:#0e1116; --panel:#111827; --border:#1f2937; --fg:#e5e7eb; --accent:#4c8bf5; }
  html,body{height:100%;margin:0;background:var(--bg);color:var(--fg);font:15px/1.35 ui-sans-serif,system-ui}
  /* FIX: give the layout a real height */
  #app{height:100vh; display:grid; grid-template-columns:280px 1fr}

  aside{padding:14px;border-right:1px solid var(--border);background:var(--panel)}
  aside h1{margin:0 0 10px;font:600 16px/1.2 ui-sans-serif}
  .row{display:grid;grid-template-columns:1fr 4.5rem;gap:.5rem;margin:10px 0}
  fieldset{border:1px solid var(--border);border-radius:10px;padding:10px;margin:12px 0}
  legend{opacity:.8}
  .btn{border:1px solid var(--border);background:#0b1220;padding:.5rem .7rem;border-radius:10px;color:var(--fg)}

  /* Canvas area */
  #stage{
    position:relative;
    /* FIX: ensure the canvas column is tall */
    height:100vh;           /* or min-height:100%; */
    overflow:hidden;
  }
  #canvas{display:block;width:100%;height:100%} /* canvas stretches to the stage */
  .overlay{position:absolute;top:10px;left:10px;background:#0008;padding:6px 10px;border-radius:10px}
</style>
</head>
<body>
<div id="app">
  <aside>
    <h1>3D Year Ring</h1>
    <fieldset>
      <legend>Dimensions</legend>
      <div class="row"><label>Outer Radius</label><input id="outerRadius" type="range" min="2" max="9" step="0.1" value="6.5"></div>
      <div class="row"><label>Inner Radius</label><input id="innerRadius" type="range" min="1" max="8" step="0.1" value="4.4"></div>
      <div class="row"><label>Height</label><input id="height" type="range" min="0.3" max="2.0" step="0.05" value="0.9"></div>
      <div class="row"><label>Gap (deg)</label><input id="gap" type="range" min="0" max="4" step="0.1" value="0.8"></div>
      <div class="row"><label>Label Size</label><input id="labelSize" type="range" min="0.1" max="0.6" step="0.02" value="0.34"></div>
      <label><input id="showOuter" type="checkbox" checked> Show Outside Labels</label><br>
      <label><input id="showInner" type="checkbox" checked> Show Inside Labels</label>
    </fieldset>
    <button id="resetView" class="btn">Reset View</button>
    <button id="autorotate" class="btn">Auto-rotate</button>
  </aside>

  <div id="stage">
    <canvas id="canvas"></canvas>
    <div class="overlay">Drag to rotate · Scroll/Pinch to zoom</div>
  </div>
</div>

<script type="module">
import * as THREE from 'https://unpkg.com/three@0.159.0/build/three.module.js';
import { OrbitControls } from 'https://unpkg.com/three@0.159.0/examples/jsm/controls/OrbitControls.js';

const months=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
const colors=['#57A7B4','#6BB8A0','#86C37A','#A0C15A','#E0B444','#F0A63E','#E9853F','#DB6A4B','#CF5C59','#E18A42','#F0B149','#7CB4A9'];

const canvas=document.getElementById('canvas');
const renderer=new THREE.WebGLRenderer({canvas,antialias:true});
renderer.setPixelRatio(Math.min(2, window.devicePixelRatio||1));
renderer.setClearColor(0x0e1116,1);

const scene=new THREE.Scene();
const camera=new THREE.PerspectiveCamera(45,1,0.1,200);
camera.position.set(0,7.5,13);
const controls=new OrbitControls(camera,renderer.domElement);
controls.enableDamping=true;

scene.add(new THREE.HemisphereLight(0xffffff,0x223344,0.7));
const dl=new THREE.DirectionalLight(0xffffff,0.8); dl.position.set(6,8,4); scene.add(dl);

const params={outerR:6.5, innerR:4.4, height:0.9, gapDeg:0.8, labelSize:0.34, showOuter:true, showInner:true, auto:false};
const ringGroup=new THREE.Group(); scene.add(ringGroup);
const labelGroup=new THREE.Group(); scene.add(labelGroup);

function makeLabelTexture(text) {
  const c=document.createElement('canvas'), ctx=c.getContext('2d');
  const pad=16, font=128; ctx.font=`700 ${font}px system-ui,-apple-system,Segoe UI,Roboto`;
  const w=(ctx.measureText(text).width|0)+pad*2, h=font+pad*2; c.width=w; c.height=h;
  ctx.font=`700 ${font}px system-ui,-apple-system,Segoe UI,Roboto`;
  ctx.fillStyle='#0d1117'; ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.fillText(text,w/2,h/2);
  const tex=new THREE.CanvasTexture(c); tex.minFilter=THREE.LinearMipmapLinearFilter; tex.generateMipmaps=true; return tex;
}

function makeWedge(i,total,outerR,innerR,height,gapDeg,color){
  const sector=(Math.PI*2)/total, gap=THREE.MathUtils.degToRad(gapDeg);
  const start=i*sector+gap/2, end=(i+1)*sector-gap/2;
  const sh=new THREE.Shape(); sh.absarc(0,0,outerR,start,end,false);
  const hole=new THREE.Path(); hole.absarc(0,0,innerR,end,start,true); sh.holes.push(hole);
  const geo=new THREE.ExtrudeGeometry(sh,{depth:height,bevelEnabled:false,curveSegments:96,steps:1});
  geo.rotateX(Math.PI/2); geo.translate(0,0,-height/2);
  const mat=new THREE.MeshStandardMaterial({color:new THREE.Color(color),metalness:0.08,roughness:0.45});
  const mesh=new THREE.Mesh(geo,mat); mesh.userData.centerAngle=(start+end)/2; mesh.userData.index=i; return mesh;
}

function addLabels(i,outerR,innerR,midAngle){
  const size=params.labelSize;
  const planes=[];
  const cfg=[
    {show:params.showOuter, radius: outerR+0.02, yaw: Math.PI/2},
    {show:params.showInner, radius: innerR-0.02, yaw:-Math.PI/2},
  ];
  cfg.forEach(({show,radius,yaw})=>{
    if(!show) return;
    const tex=makeLabelTexture(months[i]);
    const aspect=tex.image.width/tex.image.height;
    const geo=new THREE.PlaneGeometry(size*aspect,size);
    const mat=new THREE.MeshBasicMaterial({map:tex,transparent:true});
    const m=new THREE.Mesh(geo,mat);
    m.position.set(Math.cos(midAngle)*radius,0,Math.sin(midAngle)*radius);
    m.rotation.y=-midAngle+yaw;
    planes.push(m);
  });
  return planes;
}

function rebuild(){
  // clear groups
  [ringGroup,labelGroup].forEach(g=>{ while(g.children.length){const m=g.children.pop(); m.geometry?.dispose(); Array.isArray(m.material)?m.material.forEach(mm=>mm.map?.dispose()||mm.dispose()):m.material?.dispose(); }});
  params.innerR=Math.min(params.innerR, params.outerR-0.4);

  for(let i=0;i<12;i++){
    const wedge=makeWedge(i,12,params.outerR,params.innerR,params.height,params.gapDeg,colors[i%colors.length]);
    ringGroup.add(wedge);
    const a=wedge.userData.centerAngle;
    addLabels(i,params.outerR,params.innerR,a).forEach(n=>labelGroup.add(n));
  }
}
rebuild();

// highlight + click
const raycaster=new THREE.Raycaster(); const mouse=new THREE.Vector2(); let hi=null;
canvas.addEventListener('mousemove',e=>{
  const r=canvas.getBoundingClientRect();
  mouse.x=((e.clientX-r.left)/r.width)*2-1; mouse.y=-((e.clientY-r.top)/r.height)*2+1;
  raycaster.setFromCamera(mouse,camera);
  const hits=raycaster.intersectObjects(ringGroup.children,false);
  if(hi && (!hits[0] || hits[0].object!==hi)) hi.material.emissive = new THREE.Color(0x000000);
  if(hits[0]){ hi=hits[0].object; hi.material.emissive = new THREE.Color(0x222222); }
});
canvas.addEventListener('click',()=>{ if(!hi) return; const a=hi.userData.centerAngle, r=(params.outerR+params.innerR)/2+6;
  camera.position.lerp(new THREE.Vector3(Math.cos(a)*r,camera.position.y,Math.sin(a)*r),0.35); });

function onResize(){
  const w = canvas.clientWidth || canvas.getBoundingClientRect().width;
  const h = canvas.clientHeight || canvas.getBoundingClientRect().height;
  renderer.setSize(w, h, false);
  camera.aspect = w / h; camera.updateProjectionMatrix();
}
window.addEventListener('resize', onResize); onResize();

(function render(){ requestAnimationFrame(render);
  controls.update(); renderer.render(scene,camera); })();

// UI
const $=id=>document.getElementById(id);
$('outerRadius').oninput=e=>{params.outerR=+e.target.value; rebuild();};
$('innerRadius').oninput=e=>{params.innerR=+e.target.value; rebuild();};
$('height').oninput=e=>{params.height=+e.target.value; rebuild();};
$('gap').oninput=e=>{params.gapDeg=+e.target.value; rebuild();};
$('labelSize').oninput=e=>{params.labelSize=+e.target.value; rebuild();};
$('showOuter').onchange=e=>{params.showOuter=e.target.checked; rebuild();};
$('showInner').onchange=e=>{params.showInner=e.target.checked; rebuild();};
$('resetView').onclick=()=>{controls.reset(); camera.position.set(0,7.5,13);};
$('autorotate').onclick=e=>{ params.auto=!params.auto; e.target.textContent=params.auto?'Stop auto-rotate':'Auto-rotate';
  (function spin(){ if(!params.auto) return; ringGroup.rotation.y += 0.01; requestAnimationFrame(spin); })(); };
</script>
</body>
</html>
